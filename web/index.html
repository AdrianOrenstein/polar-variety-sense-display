<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Polar Verity Sense</title>
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: #e0e0e0;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* ── top bar ── */
      .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 16px;
        background: #1a1a1a;
        border-bottom: 1px solid #333;
        flex-shrink: 0;
      }
      .top-bar h1 { font-size: 14px; color: #bbb; font-weight: 500; }
      .status-badge {
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 600;
      }
      .connected   { background: #1b5e20; color: #a5d6a7; }
      .disconnected { background: #b71c1c; color: #ef9a9a; }

      /* ── stats ribbon ── */
      .stats-ribbon {
        display: flex;
        gap: 20px;
        padding: 6px 16px;
        background: #1e1e1e;
        border-bottom: 1px solid #333;
        flex-shrink: 0;
        flex-wrap: wrap;
        align-items: center;
      }
      .stat { display: flex; flex-direction: column; }
      .stat-label { font-size: 10px; color: #777; text-transform: uppercase; letter-spacing: 0.5px; }
      .stat-value { font-size: 18px; font-weight: bold; }

      /* ── chart panels 2×2 grid ── */
      .panels {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 1px;
        background: #333;
        min-height: 0;
      }
      .panel {
        background: #1e1e1e;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
      }
      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 12px;
        flex-shrink: 0;
      }
      .panel-title {
        font-size: 11px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .panel-legend {
        display: flex;
        gap: 10px;
        font-size: 10px;
      }
      .legend-item { display: flex; align-items: center; gap: 3px; }
      .legend-dot  { width: 7px; height: 7px; border-radius: 50%; }
      .chart-area  { flex: 1; min-height: 0; position: relative; }

      /* ── PPI strip ── */
      .ppi-strip {
        display: flex;
        gap: 6px;
        padding: 3px 12px;
        flex-shrink: 0;
        overflow-x: auto;
        background: #1a1a1a;
        border-top: 1px solid #333;
        scrollbar-width: none;
        min-height: 22px;
      }
      .ppi-strip::-webkit-scrollbar { display: none; }
      .ppi-pill {
        background: #2a2a2a;
        padding: 1px 8px;
        border-radius: 8px;
        font-size: 11px;
        color: #aaa;
        white-space: nowrap;
      }

      /* color helpers */
      .c-red    { color: #ff5252; }
      .c-green  { color: #69f0ae; }
      .c-blue   { color: #40c4ff; }
      .c-orange { color: #ffab40; }
      .c-pink   { color: #ea80fc; }
      .c-cyan   { color: #84ffff; }
      .c-lime   { color: #ccff90; }
      .c-acc-r  { color: #ff9e80; }
      .c-acc-b  { color: #80d8ff; }
      .c-acc-p  { color: #b388ff; }
    </style>
  </head>
  <body>
    <!-- ── Top Bar ── -->
    <div class="top-bar">
      <h1>Polar Verity Sense Dashboard</h1>
      <span id="status" class="status-badge disconnected">Disconnected</span>
    </div>

    <!-- ── Stats Ribbon ── -->
    <div class="stats-ribbon">
      <div class="stat">
        <span class="stat-label">Heart Rate</span>
        <span id="hr-val" class="stat-value c-red">--</span>
      </div>
      <div class="stat">
        <span class="stat-label">RR Interval</span>
        <span id="rr-val" class="stat-value" style="color:#ce93d8;">--</span>
      </div>
      <div class="stat">
        <span class="stat-label">PPG BPM</span>
        <span id="ppg-bpm" class="stat-value c-red" style="font-size:14px;">--</span>
      </div>
      <div class="stat">
        <span class="stat-label">PPG Ch0</span>
        <span id="ppg-ch0" class="stat-value c-red" style="font-size:14px;">--</span>
      </div>
      <div class="stat">
        <span class="stat-label">PPG Ch1</span>
        <span id="ppg-ch1" class="stat-value c-green" style="font-size:14px;">--</span>
      </div>
      <div class="stat">
        <span class="stat-label">ACC Magnitude</span>
        <span id="acc-mag" class="stat-value c-acc-r" style="font-size:14px;">--</span>
      </div>
      <div class="stat">
        <span class="stat-label">Gyro Magnitude</span>
        <span id="gyro-mag" class="stat-value c-pink" style="font-size:14px;">--</span>
      </div>
      <div class="stat">
        <span class="stat-label">MAG Magnitude</span>
        <span id="mag-mag" class="stat-value" style="font-size:14px; color:#ffd740;">--</span>
      </div>
    </div>

    <!-- ── Chart Panels (2×2) ── -->
    <div class="panels">
      <!-- PPG -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">PPG (filtered)</span>
          <div class="panel-legend">
            <span class="legend-item"><span class="legend-dot" style="background:#ff5252"></span>ch0</span>
          </div>
        </div>
        <div id="ppg-chart" class="chart-area"></div>
      </div>

      <!-- HR Timeline -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Heart Rate (BPM)</span>
        </div>
        <div id="hr-chart" class="chart-area"></div>
      </div>

      <!-- ACC -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Accelerometer (mG)</span>
          <div class="panel-legend">
            <span class="legend-item"><span class="legend-dot" style="background:#ff9e80"></span>X</span>
            <span class="legend-item"><span class="legend-dot" style="background:#80d8ff"></span>Y</span>
            <span class="legend-item"><span class="legend-dot" style="background:#b388ff"></span>Z</span>
          </div>
        </div>
        <div id="acc-chart" class="chart-area"></div>
      </div>

      <!-- Gyro -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Motion Sensors</span>
          <div class="panel-legend">
            <span class="legend-item"><span class="legend-dot" style="background:#ea80fc"></span>ACC</span>
            <span class="legend-item"><span class="legend-dot" style="background:#84ffff"></span>Gyro</span>
            <span class="legend-item"><span class="legend-dot" style="background:#ffd740"></span>MAG</span>
          </div>
        </div>
        <div id="gyro-chart" class="chart-area"></div>
      </div>
    </div>

    <!-- PPI strip at bottom -->
    <div id="ppi-strip" class="ppi-strip"></div>

    <script src="utils.js"></script>
    <script src="charts.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Derive chart height from actual panel size
        function panelH() {
          const el = document.querySelector(".chart-area");
          return el ? el.clientHeight : 250;
        }

        const h = panelH();
        const ppgChart  = new FilteredPPGChart(document.getElementById("ppg-chart"), [], h);
        const accChart  = new ACCChart(document.getElementById("acc-chart"), [], h, 52, 2);
        const motionChart = new MotionMagnitudeChart(document.getElementById("gyro-chart"), [], h);
        const hrChart   = new HRTimelineChart(document.getElementById("hr-chart"), h);

        // Value display elements
        const hrValEl    = document.getElementById("hr-val");
        const rrValEl    = document.getElementById("rr-val");
        const ppgBpmEl   = document.getElementById("ppg-bpm");
        const ppgCh0El   = document.getElementById("ppg-ch0");
        const ppgCh1El   = document.getElementById("ppg-ch1");
        const accMagEl = document.getElementById("acc-mag");
        const gyroMagEl = document.getElementById("gyro-mag");
        const magMagEl = document.getElementById("mag-mag");
        const ppiStripEl = document.getElementById("ppi-strip");

        // Resize handler
        window.addEventListener("resize", () => {
          const nh = panelH();
          ppgChart.updateHeight(nh);
          accChart.chart.updateHeight(nh);
          motionChart.updateHeight(nh);
          hrChart.updateHeight(nh);
        });

        // ── WebSocket ──
        const statusEl = document.getElementById("status");
        let ws = null;

        function connectWebSocket() {
          ws = new WebSocket("ws://127.0.0.1:8765/");

          ws.onopen = () => {
            statusEl.textContent = "Connected";
            statusEl.className = "status-badge connected";
          };

          ws.onmessage = (event) => {
            try {
              const msg = JSON.parse(event.data);

              if (msg.type === "ppg_processed" && msg.data && Array.isArray(msg.data.values)) {
                const fmt = msg.data.values.map(v => ({ v }));
                const peaks = msg.data.peaks || [];
                ppgChart.updateData(fmt, peaks);
                if (msg.data.bpm !== null && msg.data.bpm !== undefined) {
                  ppgBpmEl.textContent = `${msg.data.bpm} BPM`;
                }
                // Display RR intervals from PPG
                if (msg.data.rr_intervals && msg.data.rr_intervals.length > 0) {
                  const avgRR = msg.data.rr_intervals.reduce((a, b) => a + b, 0) / msg.data.rr_intervals.length;
                  rrValEl.textContent = `${Math.round(avgRR)} ms`;
                  
                  // Add RR interval pills to strip
                  msg.data.rr_intervals.forEach(rr => {
                    const pill = document.createElement("div");
                    pill.className = "ppi-pill";
                    pill.textContent = `${rr}`;
                    ppiStripEl.appendChild(pill);
                  });
                  // Keep only last 20 pills
                  while (ppiStripEl.children.length > 20) {
                    ppiStripEl.removeChild(ppiStripEl.firstChild);
                  }
                }
              }
              else if (msg.type === "ppg" && msg.data && Array.isArray(msg.data.samples)) {
                const fmt = msg.data.samples.map(s => ({
                  ch0: s[0], ch1: s[1], ch2: s[2], ch3: s[3]
                }));
                if (fmt.length > 0) {
                  const last = fmt[fmt.length - 1];
                  ppgCh0El.textContent = last.ch0.toLocaleString();
                  ppgCh1El.textContent = last.ch1.toLocaleString();
                }
              }
              else if (msg.type === "acc" && msg.data && Array.isArray(msg.data.data)) {
                const fmt = msg.data.data.map(p => ({ x: p[0], y: p[1], z: p[2] }));
                accChart.updateData(fmt);
                if (msg.data.magnitude !== undefined) {
                  accMagEl.textContent = `${msg.data.magnitude.toFixed(1)} mg`;
                  // Add to motion chart
                  motionChart.addAccMagnitude(msg.data.magnitude);
                }
              }
              else if (msg.type === "gyro" && msg.data && Array.isArray(msg.data.data)) {
                const fmt = msg.data.data.map(p => ({ x: p[0], y: p[1], z: p[2] }));
                // Still update individual axis chart if needed, but focus on magnitude
                if (msg.data.magnitude !== undefined) {
                  console.log("GYRO magnitude:", msg.data.magnitude, "Raw data:", msg.data.data);
                  gyroMagEl.textContent = `${msg.data.magnitude.toFixed(1)} °/s`;
                  // Add to motion chart
                  motionChart.addGyroMagnitude(msg.data.magnitude);
                }
              }
              else if (msg.type === "mag" && msg.data && Array.isArray(msg.data.data)) {
                if (msg.data.magnitude !== undefined) {
                  // Convert from nT to µT for display
                  const magUT = msg.data.magnitude / 1000;
                  magMagEl.textContent = `${magUT.toFixed(1)} µT`;
                  // Add to motion chart
                  motionChart.addMagMagnitude(magUT);
                }
              }
              else if (msg.type === "heartrate" && msg.data) {
                if (msg.data.heartrate && msg.data.heartrate > 0) {
                  const bpm = msg.data.heartrate;
                  hrValEl.textContent = `${bpm} BPM`;
                  hrChart.addHR(bpm);
                }
              }
            } catch (error) {
              console.error("Error processing WebSocket message:", error);
            }
          };

          ws.onclose = () => {
            statusEl.textContent = "Disconnected";
            statusEl.className = "status-badge disconnected";
            setTimeout(connectWebSocket, 2000);
          };

          ws.onerror = (error) => {
            console.error("WebSocket error:", error);
            ws.close();
          };
        }

        connectWebSocket();
      });
    </script>
  </body>
</html>
